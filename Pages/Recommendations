import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Sparkles, TrendingUp, RefreshCw, Plus } from "lucide-react";
import { Skeleton } from "@/components/ui/skeleton";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";

export default function Recommendations() {
  const navigate = useNavigate();
  const [recommendations, setRecommendations] = useState(null);
  const [isLoading, setIsLoading] = useState(true);

  const fetchRecommendations = async () => {
    setIsLoading(true);
    try {
      const response = await base44.integrations.Core.InvokeLLM({
        prompt: `As an AI trading advisor, provide 8 top stock recommendations for day trading today. For each stock include:
- ticker
- company_name
- current_price
- recommendation (Strong Buy/Buy/Hold)
- confidence_score (0-100)
- potential_gain_percent (realistic % for today)
- reasoning (2-3 sentences explaining why this is a good day trade)
- entry_price (suggested entry point)
- target_price (today's target)
- stop_loss (suggested stop loss)

Focus on stocks with high volume and volatility suitable for day trading. Use real current market data.`,
        add_context_from_internet: true,
        response_json_schema: {
          type: "object",
          properties: {
            recommendations: {
              type: "array",
              items: {
                type: "object",
                properties: {
                  ticker: { type: "string" },
                  company_name: { type: "string" },
                  current_price: { type: "number" },
                  recommendation: { type: "string" },
                  confidence_score: { type: "number" },
                  potential_gain_percent: { type: "number" },
                  reasoning: { type: "string" },
                  entry_price: { type: "number" },
                  target_price: { type: "number" },
                  stop_loss: { type: "number" }
                }
              }
            },
            market_sentiment: { type: "string" },
            best_sectors_today: {
              type: "array",
              items: { type: "string" }
            }
          }
        }
      });

      setRecommendations(response);
    } catch (error) {
      console.error("Error fetching recommendations:", error);
    }
    setIsLoading(false);
  };

  useEffect(() => {
    fetchRecommendations();
  }, []);

  const handleAddToWatchlist = async (stock) => {
    await base44.entities.Watchlist.create({
      ticker: stock.ticker,
      company_name: stock.company_name,
      target_price: stock.target_price,
      alert_type: "buy_below"
    });
    alert(`${stock.ticker} added to watchlist!`);
  };

  return (
    <div className="p-6 md:p-8 space-y-6">
      <div className="flex justify-between items-start">
        <div>
          <h2 className="text-3xl font-bold bg-gradient-to-r from-emerald-400 to-emerald-600 bg-clip-text text-transparent flex items-center gap-2">
            <Sparkles className="w-8 h-8 text-emerald-400" />
            AI Recommendations
          </h2>
          <p className="text-zinc-400 mt-1">Personalized stock picks powered by AI analysis</p>
        </div>
        <Button
          onClick={fetchRecommendations}
          disabled={isLoading}
          className="bg-emerald-600 hover:bg-emerald-700"
        >
          <RefreshCw className={`w-4 h-4 mr-2 ${isLoading ? 'animate-spin' : ''}`} />
          Refresh
        </Button>
      </div>

      {isLoading ? (
        <div className="space-y-6">
          <div className="grid md:grid-cols-3 gap-4">
            {[1, 2, 3].map((i) => (
              <Skeleton key={i} className="h-24 bg-zinc-900/50 border border-zinc-800" />
            ))}
          </div>
          <div className="grid md:grid-cols-2 gap-4">
            {[1, 2, 3, 4].map((i) => (
              <Skeleton key={i} className="h-64 bg-zinc-900/50 border border-zinc-800" />
            ))}
          </div>
        </div>
      ) : (
        <>
          {/* Market Overview */}
          <div className="grid md:grid-cols-3 gap-4">
            <Card className="bg-gradient-to-br from-emerald-900/30 to-emerald-900/10 border-emerald-800/50">
              <CardHeader className="pb-3">
                <CardTitle className="text-sm font-medium text-emerald-400">Market Sentiment</CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-2xl font-bold">{recommendations?.market_sentiment}</p>
              </CardContent>
            </Card>

            <Card className="md:col-span-2 bg-zinc-900/50 border-zinc-800">
              <CardHeader className="pb-3">
                <CardTitle className="text-sm font-medium text-zinc-400">Hot Sectors Today</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="flex flex-wrap gap-2">
                  {recommendations?.best_sectors_today?.map((sector, i) => (
                    <Badge key={i} className="bg-emerald-500/20 text-emerald-400 border-emerald-500/30 border">
                      <TrendingUp className="w-3 h-3 mr-1" />
                      {sector}
                    </Badge>
                  ))}
                </div>
              </CardContent>
            </Card>
          </div>

          {/* Recommendations */}
          <div className="grid md:grid-cols-2 gap-6">
            {recommendations?.recommendations?.map((stock, index) => (
              <Card key={index} className="bg-zinc-900/50 border-zinc-800 hover:border-emerald-500/30 transition-all">
                <CardHeader>
                  <div className="flex justify-between items-start">
                    <div>
                      <CardTitle className="text-2xl font-bold">{stock.ticker}</CardTitle>
                      <p className="text-sm text-zinc-400 mt-1">{stock.company_name}</p>
                    </div>
                    <Badge className={`${
                      stock.recommendation === 'Strong Buy' ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30' :
                      'bg-blue-500/20 text-blue-400 border-blue-500/30'
                    } border text-base px-3 py-1`}>
                      {stock.recommendation}
                    </Badge>
                  </div>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="flex justify-between items-baseline">
                    <div>
                      <p className="text-sm text-zinc-500">Current Price</p>
                      <p className="text-2xl font-bold">${stock.current_price}</p>
                    </div>
                    <div className="text-right">
                      <p className="text-sm text-zinc-500">Potential Gain</p>
                      <p className="text-2xl font-bold text-emerald-400">+{stock.potential_gain_percent}%</p>
                    </div>
                  </div>

                  <div className="space-y-2">
                    <div className="flex justify-between text-sm">
                      <span className="text-zinc-500">Confidence</span>
                      <span className="font-semibold">{stock.confidence_score}%</span>
                    </div>
                    <div className="w-full bg-zinc-800 rounded-full h-2">
                      <div
                        className="bg-gradient-to-r from-emerald-500 to-emerald-600 h-2 rounded-full"
                        style={{ width: `${stock.confidence_score}%` }}
                      ></div>
                    </div>
                  </div>

                  <div className="p-3 bg-zinc-800/50 rounded-lg space-y-2 text-sm">
                    <div className="flex justify-between">
                      <span className="text-zinc-500">Entry Price:</span>
                      <span className="font-semibold">${stock.entry_price}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-zinc-500">Target Price:</span>
                      <span className="font-semibold text-emerald-400">${stock.target_price}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-zinc-500">Stop Loss:</span>
                      <span className="font-semibold text-red-400">${stock.stop_loss}</span>
                    </div>
                  </div>

                  <p className="text-sm text-zinc-400 leading-relaxed">{stock.reasoning}</p>

                  <div className="flex gap-2 pt-2">
                    <Button
                      onClick={() => navigate(createPageUrl("StockAnalyzer") + `?ticker=${stock.ticker}`)}
                      className="flex-1 bg-emerald-600 hover:bg-emerald-700"
                    >
                      Full Analysis
                    </Button>
                    <Button
                      onClick={() => handleAddToWatchlist(stock)}
                      variant="outline"
                      className="border-zinc-700 hover:bg-zinc-800"
                    >
                      <Plus className="w-4 h-4" />
                    </Button>
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>

          <Card className="bg-amber-500/10 border-amber-500/30">
            <CardContent className="pt-6">
              <p className="text-sm text-amber-400">
                <strong>Risk Disclaimer:</strong> These AI-generated recommendations are for informational purposes only and should not be considered financial advice. Day trading carries significant risk. Past performance does not guarantee future results. Always conduct your own research and consider consulting with a licensed financial advisor before making any investment decisions.
              </p>
            </CardContent>
          </Card>
        </>
      )}
    </div>
  );
}
