import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { useQuery } from "@tanstack/react-query";
import { Button } from "@/components/ui/button";
import { RefreshCw, Plus } from "lucide-react";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import TrendingStocksAnalysis from "../components/trading/TrendingStocksAnalysis";
import TradeSummary from "../components/trading/TradeSummary";
import AIInsights from "../components/trading/AIInsights";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";

export default function Dashboard() {
  const navigate = useNavigate();
  const [trendingAnalysis, setTrendingAnalysis] = useState(null);
  const [insights, setInsights] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [isRefreshing, setIsRefreshing] = useState(false);
  const [showAddTradeDialog, setShowAddTradeDialog] = useState(false);
  const [newTrade, setNewTrade] = useState({
    ticker: "",
    action: "buy",
    shares: "",
    entry_price: "",
    trade_date: new Date().toISOString().split('T')[0],
    status: "open"
  });

  const { data: trades, isLoading: tradesLoading, refetch: refetchTrades } = useQuery({
    queryKey: ['trades'],
    queryFn: () => base44.entities.Trade.list('-trade_date'),
    initialData: [],
  });

  const fetchMarketData = async () => {
    setIsRefreshing(true);
    try {
      const response = await base44.integrations.Core.InvokeLLM({
        prompt: `Give me a comprehensive market analysis including:
1. Analysis of 5 trending stocks right now with ticker, company, current price, % change, volume, volatility level, momentum (bullish/bearish), and detailed analysis of why they're trending and their trading potential
2. 3 key AI-powered market insights with sentiment (bullish/bearish/neutral) and sector

Focus on stocks with high volume and volatility that are suitable for day trading. Use real current market data.`,
        add_context_from_internet: true,
        response_json_schema: {
          type: "object",
          properties: {
            trending_stocks: {
              type: "object",
              properties: {
                stocks: {
                  type: "array",
                  items: {
                    type: "object",
                    properties: {
                      ticker: { type: "string" },
                      company: { type: "string" },
                      price: { type: "number" },
                      change: { type: "number" },
                      volume: { type: "string" },
                      volatility: { type: "string" },
                      momentum: { type: "string" },
                      analysis: { type: "string" }
                    }
                  }
                }
              }
            },
            insights: {
              type: "array",
              items: {
                type: "object",
                properties: {
                  sentiment: { type: "string" },
                  sector: { type: "string" },
                  insight: { type: "string" }
                }
              }
            }
          }
        }
      });

      setTrendingAnalysis(response.trending_stocks);
      setInsights(response.insights);
    } catch (error) {
      console.error("Error fetching market data:", error);
    }
    setIsLoading(false);
    setIsRefreshing(false);
  };

  useEffect(() => {
    fetchMarketData();
  }, []);

  const handleAddTrade = async () => {
    await base44.entities.Trade.create({
      ...newTrade,
      shares: parseFloat(newTrade.shares),
      entry_price: parseFloat(newTrade.entry_price)
    });
    
    setShowAddTradeDialog(false);
    setNewTrade({
      ticker: "",
      action: "buy",
      shares: "",
      entry_price: "",
      trade_date: new Date().toISOString().split('T')[0],
      status: "open"
    });
    refetchTrades();
  };

  return (
    <div className="p-6 md:p-8 space-y-6">
      <div className="flex justify-between items-center">
        <div>
          <h2 className="text-3xl font-bold bg-gradient-to-r from-emerald-400 to-emerald-600 bg-clip-text text-transparent">
            Market Dashboard
          </h2>
          <p className="text-zinc-400 mt-1">Live market analysis and your trading activity</p>
        </div>
        <div className="flex gap-3">
          <Dialog open={showAddTradeDialog} onOpenChange={setShowAddTradeDialog}>
            <DialogTrigger asChild>
              <Button variant="outline" className="border-zinc-700 hover:bg-zinc-800">
                <Plus className="w-4 h-4 mr-2" />
                Log Trade
              </Button>
            </DialogTrigger>
            <DialogContent className="bg-zinc-900 border-zinc-800">
              <DialogHeader>
                <DialogTitle>Log New Trade</DialogTitle>
              </DialogHeader>
              <div className="space-y-4">
                <div>
                  <Label>Ticker</Label>
                  <Input
                    value={newTrade.ticker}
                    onChange={(e) => setNewTrade({...newTrade, ticker: e.target.value.toUpperCase()})}
                    placeholder="AAPL"
                    className="bg-zinc-800 border-zinc-700"
                  />
                </div>
                <div>
                  <Label>Action</Label>
                  <Select value={newTrade.action} onValueChange={(value) => setNewTrade({...newTrade, action: value})}>
                    <SelectTrigger className="bg-zinc-800 border-zinc-700">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="buy">Buy</SelectItem>
                      <SelectItem value="sell">Sell</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label>Shares</Label>
                    <Input
                      type="number"
                      value={newTrade.shares}
                      onChange={(e) => setNewTrade({...newTrade, shares: e.target.value})}
                      placeholder="100"
                      className="bg-zinc-800 border-zinc-700"
                    />
                  </div>
                  <div>
                    <Label>Entry Price</Label>
                    <Input
                      type="number"
                      step="0.01"
                      value={newTrade.entry_price}
                      onChange={(e) => setNewTrade({...newTrade, entry_price: e.target.value})}
                      placeholder="150.00"
                      className="bg-zinc-800 border-zinc-700"
                    />
                  </div>
                </div>
                <div>
                  <Label>Trade Date</Label>
                  <Input
                    type="date"
                    value={newTrade.trade_date}
                    onChange={(e) => setNewTrade({...newTrade, trade_date: e.target.value})}
                    className="bg-zinc-800 border-zinc-700"
                  />
                </div>
                <Button 
                  onClick={handleAddTrade}
                  className="w-full bg-emerald-600 hover:bg-emerald-700"
                  disabled={!newTrade.ticker || !newTrade.shares || !newTrade.entry_price}
                >
                  Log Trade
                </Button>
              </div>
            </DialogContent>
          </Dialog>
          <Button
            onClick={fetchMarketData}
            disabled={isRefreshing}
            className="bg-emerald-600 hover:bg-emerald-700"
          >
            <RefreshCw className={`w-4 h-4 mr-2 ${isRefreshing ? 'animate-spin' : ''}`} />
            Refresh
          </Button>
        </div>
      </div>

      <div className="grid lg:grid-cols-3 gap-6">
        <div className="lg:col-span-2">
          <TrendingStocksAnalysis analysis={trendingAnalysis} isLoading={isLoading} />
        </div>
        
        <div className="space-y-6">
          <TradeSummary trades={trades} isLoading={tradesLoading} />
          <AIInsights insights={insights} isLoading={isLoading} />
        </div>
      </div>
    </div>
  );
}
